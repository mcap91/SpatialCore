---
title: "Spatial Statistics Analysis: {{< meta dataset_name >}}"
author: "SpatialCore"
date: today
params:
  dataset_name: "dataset"
  input_h5ad: "processed.h5ad"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    self-contained: true
---

```{python}
#| label: setup
#| include: false

import anndata as ad
import scanpy as sc
import squidpy as sq
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from pathlib import Path

# Load the data
adata = ad.read_h5ad(params["input_h5ad"])
```

## Overview

This report documents spatial statistics analysis for **`{python} params["dataset_name"]`**.

## Spatial Autocorrelation

### Moran's I

```{python}
#| label: morans-i
#| fig-cap: "Moran's I statistics for spatially variable genes"

# Check if Moran's I has been computed
if "moranI" in adata.uns:
    morans = adata.uns["moranI"]
    top_genes = morans.nlargest(20, "I")

    fig, ax = plt.subplots(figsize=(10, 6))
    ax.barh(top_genes.index, top_genes["I"], edgecolor="black")
    ax.set_xlabel("Moran's I")
    ax.set_ylabel("Gene")
    ax.set_title("Top 20 Spatially Variable Genes (Moran's I)")
    plt.tight_layout()
    plt.show()
else:
    print("Run Moran's I analysis first using spatialcore.spatial.morans_i()")
```

## Spatial Expression Patterns

```{python}
#| label: spatial-expression
#| fig-cap: "Spatial expression of top variable genes"

if "moranI" in adata.uns and "spatial" in adata.obsm:
    top_genes = adata.uns["moranI"].nlargest(4, "I").index.tolist()

    fig, axes = plt.subplots(2, 2, figsize=(12, 12))
    axes = axes.flatten()

    for ax, gene in zip(axes, top_genes):
        if gene in adata.var_names:
            sc.pl.embedding(
                adata,
                basis="spatial",
                color=gene,
                ax=ax,
                show=False,
                title=gene
            )
    plt.tight_layout()
    plt.show()
```

## Session Info

```{python}
#| label: session-info

import sys
print(f"Python: {sys.version}")
print(f"scanpy: {sc.__version__}")
print(f"squidpy: {sq.__version__}")
print(f"anndata: {ad.__version__}")
```
