---
title: "Spatial Domains Analysis: {{< meta dataset_name >}}"
author: "SpatialCore"
date: today
params:
  dataset_name: "dataset"
  input_h5ad: "processed.h5ad"
  output_h5ad: "domains.h5ad"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    self-contained: true
---

```{python}
#| label: setup
#| include: false

import anndata as ad
import scanpy as sc
import squidpy as sq
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from pathlib import Path

# Load the data
adata = ad.read_h5ad(params["input_h5ad"])
```

## Overview

This report documents the spatial domain analysis for **`{python} params["dataset_name"]`**.

### Input Data Summary

| Metric | Value |
|--------|-------|
| Cells | `{python} f"{adata.n_obs:,}"` |
| Features | `{python} f"{adata.n_vars:,}"` |
| Input File | `{python} params["input_h5ad"]` |

## Domain Detection

### Method Parameters

```{python}
#| label: parameters
#| echo: false

# Display parameters used for domain detection
if "spatialcore_metadata" in adata.uns:
    metadata = adata.uns["spatialcore_metadata"]
    # Find domain-related metadata
    domain_params = {k: v for k, v in metadata.items() if "domain" in k.lower()}
    if domain_params:
        for k, v in domain_params.items():
            print(f"{k}: {v}")
    else:
        print("No domain parameters recorded in metadata")
else:
    print("Run domain detection first")
```

## Spatial Domain Visualization

```{python}
#| label: domain-spatial
#| fig-cap: "Spatial distribution of detected domains"

# Check for domain annotations
domain_cols = [col for col in adata.obs.columns if "domain" in col.lower()]

if domain_cols and "spatial" in adata.obsm:
    fig, axes = plt.subplots(1, len(domain_cols), figsize=(8*len(domain_cols), 8))
    if len(domain_cols) == 1:
        axes = [axes]

    for ax, col in zip(axes, domain_cols):
        sc.pl.embedding(
            adata,
            basis="spatial",
            color=col,
            ax=ax,
            show=False,
            title=f"Domains: {col}"
        )
    plt.tight_layout()
    plt.show()
else:
    print("No domain annotations or spatial coordinates found")
```

## Domain Statistics

```{python}
#| label: domain-stats
#| fig-cap: "Number of cells per domain"

if domain_cols:
    for col in domain_cols:
        print(f"\n{col}:")
        counts = adata.obs[col].value_counts()
        print(counts.to_string())

        fig, ax = plt.subplots(figsize=(10, 4))
        counts.plot(kind="bar", ax=ax, edgecolor="black")
        ax.set_xlabel("Domain")
        ax.set_ylabel("Number of Cells")
        ax.set_title(f"Cells per Domain ({col})")
        plt.xticks(rotation=45, ha="right")
        plt.tight_layout()
        plt.show()
else:
    print("No domain annotations found")
```

## Domain Markers

```{python}
#| label: domain-markers
#| fig-cap: "Top marker genes per domain"

if domain_cols:
    for col in domain_cols:
        if adata.obs[col].nunique() > 1:
            # Run differential expression if not already done
            key = f"rank_genes_{col}"
            if key not in adata.uns:
                sc.tl.rank_genes_groups(adata, col, method="wilcoxon")
                key = "rank_genes_groups"

            sc.pl.rank_genes_groups(adata, key=key, n_genes=10, show=False)
            plt.tight_layout()
            plt.show()
else:
    print("No domain annotations found")
```

## Session Info

```{python}
#| label: session-info

import sys
print(f"Python: {sys.version}")
print(f"scanpy: {sc.__version__}")
print(f"squidpy: {sq.__version__}")
print(f"anndata: {ad.__version__}")
```
