---
title: "Clustering Analysis: {{< meta dataset_name >}}"
author: "SpatialCore"
date: today
params:
  dataset_name: "dataset"
  input_h5ad: "processed.h5ad"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
    self-contained: true
---

```{python}
#| label: setup
#| include: false

import anndata as ad
import scanpy as sc
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from pathlib import Path

# Load the data
adata = ad.read_h5ad(params["input_h5ad"])
```

## Overview

This report documents clustering analysis for **`{python} params["dataset_name"]`**.

## Clustering Results

```{python}
#| label: clustering-viz
#| fig-cap: "UMAP visualization of clusters"

cluster_cols = [col for col in adata.obs.columns if "leiden" in col.lower() or "cluster" in col.lower()]

if cluster_cols and "X_umap" in adata.obsm:
    fig, axes = plt.subplots(1, len(cluster_cols), figsize=(8*len(cluster_cols), 8))
    if len(cluster_cols) == 1:
        axes = [axes]

    for ax, col in zip(axes, cluster_cols):
        sc.pl.umap(adata, color=col, ax=ax, show=False, title=col)
    plt.tight_layout()
    plt.show()
else:
    print("Run clustering or UMAP first")
```

## Spatial Clustering

```{python}
#| label: spatial-clusters
#| fig-cap: "Spatial distribution of clusters"

if cluster_cols and "spatial" in adata.obsm:
    fig, axes = plt.subplots(1, len(cluster_cols), figsize=(8*len(cluster_cols), 8))
    if len(cluster_cols) == 1:
        axes = [axes]

    for ax, col in zip(axes, cluster_cols):
        sc.pl.embedding(adata, basis="spatial", color=col, ax=ax, show=False)
    plt.tight_layout()
    plt.show()
```

## Cluster Statistics

```{python}
#| label: cluster-stats

if cluster_cols:
    for col in cluster_cols:
        print(f"\n{col}:")
        print(adata.obs[col].value_counts().to_string())
```

## Session Info

```{python}
#| label: session-info

import sys
print(f"Python: {sys.version}")
print(f"scanpy: {sc.__version__}")
print(f"anndata: {ad.__version__}")
```
